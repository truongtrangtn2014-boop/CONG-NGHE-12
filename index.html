<!DOCTYPE html>
<!--
  AI Nh·∫≠n D·∫°ng Linh Ki·ªán - Phi√™n b·∫£n ho√†n ch·ªânh cho ƒëi·ªán tho·∫°i
  ----------------------------------------------
  H∆∞·ªõng d·∫´n:
  1Ô∏è‚É£ ƒê·∫∑t th∆∞ m·ª•c model ch·ª©a model.json, metadata.json, weights.bin c·∫°nh file n√†y.
  2Ô∏è‚É£ M·ªü file index.html b·∫±ng HTTPS (GitHub Pages khuy·∫øn kh√≠ch).
  3Ô∏è‚É£ S·ª≠a SHEETS_WEBHOOK_URL trong CONFIG n·∫øu mu·ªën ghi k·∫øt qu·∫£ l√™n Google Sheets.
-->
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>·ª®NG D·ª§NG AI NH·∫¨N DI·ªÜN LINH KI·ªÜN ƒêI·ªÜN T·ª¨ - C√îNG NGH·ªÜ 12</title>

  <!-- TensorFlow.js & Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

  <style>
    :root{--accent:#0ea5a6;--soft:#f7fafc}
    *{box-sizing:border-box}
    body{
      font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      margin:0;
      color:#0f172a;
      background:url('https://cdn.openai.com/chatgpt/teacher_ai/machdientu.png') no-repeat center center fixed;
      background-size:cover;
    }
    /* L·ªõp ph·ªß l√†m m·ªù n·ªÅn */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:rgba(255,255,255,0.75);
      backdrop-filter:blur(2px);
      z-index:-1;
    }

    header{padding:12px 16px;display:flex;align-items:center;gap:12px}
    header h1{font-size:18px;margin:0}
    .wrap{padding:10px}
    .cam-card{background:white;border-radius:14px;padding:10px;box-shadow:0 6px 18px rgba(8,15,24,0.06);}
    video{width:100%;border-radius:10px;background:#000}
    .controls{display:flex;gap:8px;margin-top:8px}
    .btn{flex:1;padding:10px;border-radius:10px;border:none;font-weight:600}
    .btn-primary{background:var(--accent);color:white}
    .btn-ghost{background:transparent;border:1px solid #e6eef0}
    #resultCard{margin-top:12px;background:white;border-radius:12px;padding:12px}
    .label{font-size:16px;font-weight:700}
    .prob{font-size:13px;color:#475569}
    .desc{margin-top:8px;color:#0f172a}
    .quiz{margin-top:10px;padding-top:10px;border-top:1px dashed #e6eef0}
    .quiz button{display:block;width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #e6eef0;background:white}
    .row{display:flex;gap:8px}
    input[type="text"]{padding:8px;border-radius:8px;border:1px solid #e6eef0;flex:1}
    footer{padding:12px;text-align:center;color:#64748b;font-size:13px}
    @media(min-width:720px){body{padding:20px}.wrap{max-width:720px;margin:auto}}
  </style>
</head>
<body>
  <header>
    <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#0ea5a6"/><path d="M7.5 15.5L11 11L16.5 16" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <h1>·ª®NG D·ª§NG AI NH·∫¨N DI·ªÜN LINH KI·ªÜN ƒêI·ªÜN T·ª¨ - C√îNG NGH·ªÜ 12</h1>
  </header>

  <div class="wrap">
    <div class="cam-card">
      <video id="webcam" playsinline autoplay muted></video>
      <div class="controls">
        <button id="btnStart" class="btn btn-primary">B·∫≠t camera</button>
        <button id="btnStop" class="btn btn-ghost">T·∫Øt</button>
      </div>

      <div id="resultCard" hidden>
        <div class="label" id="labelText">--</div>
        <div class="prob" id="probText">--</div>
        <div class="desc" id="descText">--</div>
        <div class="quiz" id="quizArea"></div>
      </div>
    </div>

    <div style="margin-top:12px;background:white;padding:10px;border-radius:12px;box-shadow:0 6px 18px rgba(8,15,24,0.04)">
      <div style="font-weight:700;margin-bottom:6px">Th√¥ng tin h·ªçc sinh (ƒë·ªÉ l∆∞u k·∫øt qu·∫£)</div>
      <div class="row">
        <input id="studentName" type="text" placeholder="T√™n h·ªçc sinh" />
        <input id="studentClass" type="text" placeholder="L·ªõp" style="width:110px" />
      </div>
      <div style="margin-top:8px;font-size:13px;color:#475569">L∆∞u √Ω: th√™m URL Google Apps Script Web App v√†o <code>SHEETS_WEBHOOK_URL</code> trong ph·∫ßn CONFIG ƒë·ªÉ l∆∞u k·∫øt qu·∫£.</div>
    </div>
  </div>

  <footer>Phi√™n b·∫£n m·∫´u ‚Ä¢ T·∫£i model v√†o th∆∞ m·ª•c <code>model/</code> v√† upload l√™n GitHub Pages</footer>

  <script>
    /*************************** CONFIG ***************************/
    const CONFIG = {
      MODEL_BASE_URL: './model/', // Th∆∞ m·ª•c ch·ª©a model.json
      SHEETS_WEBHOOK_URL: '',     // D√°n URL Google Apps Script t·∫°i ƒë√¢y
      COMPONENT_INFO: {
        "ƒêi·ªán tr·ªü": {
          short: "ƒêi·ªán tr·ªü",
          desc: "Gi·∫£m d√≤ng ƒëi·ªán, chia ƒëi·ªán √°p. C·∫•u t·∫°o: v·∫≠t li·ªáu ƒëi·ªán tr·ªü. Nguy√™n l√Ω: ƒë·ªãnh lu·∫≠t Ohm.",
          quiz: [{q:"ƒêi·ªán tr·ªü c√≥ ch·ª©c nƒÉng n√†o sau ƒë√¢y?",a:["T√≠ch ƒëi·ªán","Gi·∫£m d√≤ng ƒëi·ªán","TƒÉng ƒëi·ªán √°p"],correct:1}]
        },
        "T·ª• ƒëi·ªán": {
          short: "T·ª• ƒëi·ªán",
          desc: "T√≠ch tr·ªØ nƒÉng l∆∞·ª£ng ƒëi·ªán d∆∞·ªõi d·∫°ng ƒëi·ªán tr∆∞·ªùng gi·ªØa hai b·∫£n c·ª±c. D√πng l·ªçc, gh√©p t√≠n hi·ªáu.",
          quiz: [{q:"T·ª• ƒëi·ªán d√πng ƒë·ªÉ?",a:["L∆∞u tr·ªØ ƒëi·ªán t√≠ch","Khu·∫øch ƒë·∫°i t√≠n hi·ªáu","Chuy·ªÉn ƒë·ªïi AC‚ÜíDC"],correct:0}]
        },
        "Diode": {
          short: "Diode",
          desc: "Cho d√≤ng ƒëi·ªán ƒëi m·ªôt chi·ªÅu, d√πng ch·ªânh l∆∞u, b·∫£o v·ªá ng∆∞·ª£c, LED l√† diode ph√°t s√°ng.",
          quiz: [{q:"Diode cho d√≤ng ƒëi·ªán ƒëi theo?",a:["Hai chi·ªÅu","M·ªôt chi·ªÅu","Kh√¥ng cho d√≤ng"],correct:1}]
        },
        "Transistor": {
          short: "Transistor",
          desc: "D√πng khu·∫øch ƒë·∫°i v√† ƒë√≥ng/c·∫Øt t√≠n hi·ªáu. C√≥ lo·∫°i NPN v√† PNP.",
          quiz: [{q:"Transistor c√≥ th·ªÉ d√πng ƒë·ªÉ?",a:["L∆∞u tr·ªØ d·ªØ li·ªáu l√¢u d√†i","Khu·∫øch ƒë·∫°i t√≠n hi·ªáu","T·∫°o ƒëi·ªán √°p c·ªë ƒë·ªãnh"],correct:1}]
        },
        "IC": {
          short: "IC (M·∫°ch t√≠ch h·ª£p)",
          desc: "M·∫°ch t√≠ch h·ª£p nhi·ªÅu linh ki·ªán nh·ªè tr√™n chip, d√πng cho x·ª≠ l√Ω v√† ƒëi·ªÅu khi·ªÉn.",
          quiz: [{q:"IC l√† g√¨?",a:["ƒêi·ªán tr·ªü l·ªõn","M·∫°ch t√≠ch h·ª£p","M·ªôt lo·∫°i t·ª•"],correct:1}]
        }
      }
    };
    /**************************************************************/

    let model, webcam, running=false, maxPredictions;
    const videoEl=document.getElementById('webcam');
    const btnStart=document.getElementById('btnStart');
    const btnStop=document.getElementById('btnStop');
    const labelText=document.getElementById('labelText');
    const probText=document.getElementById('probText');
    const descText=document.getElementById('descText');
    const resultCard=document.getElementById('resultCard');
    const quizArea=document.getElementById('quizArea');

    btnStart.addEventListener('click',start);
    btnStop.addEventListener('click',stop);

    async function initModel(){
      try{
        model=await tmImage.load(CONFIG.MODEL_BASE_URL+'model.json',CONFIG.MODEL_BASE_URL+'metadata.json');
        maxPredictions=model.getTotalClasses();
        console.log('Model loaded.');
      }catch(e){alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c model: '+e);}
    }

    async function start(){
      if(!model) await initModel();
      if(running) return;
      try{webcam=await tmImage.Webcam.getUserMedia({facingMode:'environment'});}
      catch(e){webcam=new tmImage.Webcam(320,240,true);await webcam.setup();await webcam.play();}
      videoEl.srcObject=webcam.webcam?webcam.webcam.stream:null;
      resultCard.hidden=false;running=true;predictLoop();
    }

    function stop(){
      running=false;resultCard.hidden=true;quizArea.innerHTML='';
      labelText.innerText='--';probText.innerText='--';descText.innerText='--';
      if(webcam?.webcam?.stream){webcam.webcam.stream.getTracks().forEach(t=>t.stop());}
    }

    async function predictLoop(){
      if(!running) return;
      try{
        const prediction=await model.predict(videoEl);
        prediction.sort((a,b)=>b.probability-a.probability);
        const best=prediction[0];
        const name=best.className;
        const prob=Math.round(best.probability*100);
        labelText.innerText=CONFIG.COMPONENT_INFO[name]?.short||name;
        probText.innerText=`ƒê·ªô tin c·∫≠y: ${prob}%`;
        descText.innerText=CONFIG.COMPONENT_INFO[name]?.desc||'Ch∆∞a c√≥ m√¥ t·∫£.';
        if(prob>=60) showQuizFor(name);
      }catch(e){console.error(e);}
      requestAnimationFrame(predictLoop);
    }

    let lastQuizFor=null;
    function showQuizFor(name){
      if(lastQuizFor===name) return;
      lastQuizFor=name;
      const info=CONFIG.COMPONENT_INFO[name];
      if(!info?.quiz){quizArea.innerHTML='<div style="color:#64748b">Kh√¥ng c√≥ c√¢u h·ªèi.</div>';return;}
      const q=info.quiz[Math.floor(Math.random()*info.quiz.length)];
      let html=`<div style="font-weight:700">C√¢u h·ªèi ki·ªÉm tra</div><div style="margin-top:6px">${q.q}</div>`;
      q.a.forEach((ans,i)=>html+=`<button onclick="handleAnswer('${name}',${i},${q.correct})">${ans}</button>`);
      quizArea.innerHTML=html;
    }

    window.handleAnswer=function(name,chosen,correct){
      const ok=chosen===correct;
      const sName=document.getElementById('studentName').value||'Kh√°ch';
      const sClass=document.getElementById('studentClass').value||'';
      alert(ok?'ƒê√∫ng r·ªìi! üéâ':'Sai r·ªìi üòÖ. ƒê√°p √°n ƒë√∫ng l√† '+(correct+1));
      if(CONFIG.SHEETS_WEBHOOK_URL){
        const data={student:sName,class:sClass,component:name,correct:ok,timestamp:new Date().toISOString()};
        fetch(CONFIG.SHEETS_WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
      }
      setTimeout(()=>{lastQuizFor=null;quizArea.innerHTML='';},1200);
    }

    (async()=>{try{await initModel();console.log('Model preload ok');}catch(e){}})();
  </script>
</body>
</html>
